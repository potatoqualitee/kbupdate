name: Windows test
on: [push]

jobs:
  build:
    name: Let's see what needs to be installed
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v1
      - name: Check for needed updates
        shell: powershell
        run: |
          Write-Output "Starting services"
          Set-Service wuauserv -StartupType Automatic
          Set-Service WinRM -StartupType Automatic
          Start-Service wuauserv
          Start-Service WinRM
          Write-Output "Enabling WinRM"
          Enable-PSRemoting -Force
          Write-Output "Downloading modules"
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSFramework, kbupdate-library, PSSQLite
          Import-Module ./kbupdate.psd1 -ErrorAction Stop
          Write-Output "Saving scanfile"
          $scanfile = Save-KbScanFile -Path C:\temp -AllowClobber
          Write-Output "Getting needed updates"
          Get-KbNeededUpdate -ScanFilePath $scanfile | Where-Object Link | Select-Object -First 1 -OutVariable saveit
          $null = mkdir C:\temp\xml
          Write-Output "Found $($saveit.KBUpdate.Count) updates"
          $saveit | Export-CliXml -Path C:\temp\xml\results.xml
          $null = $saveit | Save-KbUpdate -Path C:\temp
          Write-Output "Installing needed updates"
          $saveit | Install-KbUpdate -RepositoryPath C:\temp -Verbose
          Get-KbInstalledUpdate -Pattern $saveit.KBUpdate
          $error | Export-CliXml -Path C:\temp\xml\error.xml

      - name: ðŸª  Upload
        uses: actions/upload-artifact@v3
        with:
          name: needed
          path: "C:\\temp\\xml"
